---
layout: post
title:  "iptables"
date:   2020-08-02
categories: Linux
---

- netfilter能力
  - NAT
  - 数据包修改
  - 数据包过滤
- service iptables start
  - iptables不是daemon，并不算个真正的服务，启动iptables服务等同于在加载文件里的已有规则：iptables-restore /etc/sysconfig/iptables
- chain
  - 是数据的关卡
  - 原本只需要INPUT和OUTPUT两个
  - 由于内核支持IP_FORWARD，chain又多了PREROUTING，FORWARD，POSTROUTING
- 报文流向
  - 到本机: PREROUTING -> INPUT
  - 经本机转发: PREROUTING -> FORWARD -> POSTROUTING
  - 从本机出: OUPUT -> POSTROUTING
- table
  - raw table: 不用nat table上的会话
  - mangle table: 改报文
  - nat table
  - filter table
- table优先级(由高到低)
  - raw --> mangle --> nat --> filter
- chain中可能有的table
  - prerouting:  raw, mangle, nat
  - input:       mangle, nat, filter
  - forward:     mangle, filter
  - output:      raw, mangle, nat, filter
  - postrouting: mangle, nat
- rule
  - 匹配
    - 基本
      - 源ip
      - 目ip
    - 扩展
      - 源port
      - 目port
  - action/target
    - accept
    - drop
    - reject
    - snat
    - masquerade
    - dnat
    - redirect
    - log


- 例子
  - ```iptables -t filter -L``` 指定table
  - ```iptables -L INPUT``` 指定chain
  - ```iptables -t filter -Lnv --line-number```  -n ip和端口不翻译，-v 显示计数
  - ```iptables -t filter -I INPUT -s 192.168.1.1 -j DROP```
  - ```iptables -t filter -I INPUT -s 192.168.1.1,192.168.1.2 -j DROP```   逗号指定多个
  - ```iptables -t filter -I INPUT -s ! 192.168.1.1 -j DROP```   取反
  - ```iptables -t filter -I INPUT 2 -s 192.168.0.0/16 -j ACCEPT```  这条变成第2条
  - ```iptables -t filter -I INPUT -s 192.168.1.1 -p tcp -j DROP```   指定协议
  - ```iptables -F INPUT``` 清空INPUT chain
  - ```iptables -t filter -D INPUT 3```  删第3条
- 保存规则
  - 安装iptables-services
  - `service iptables save`： 保存在/etc/sysconfig/iptables
  - `iptables-save`： 只是打印在屏幕上
- 基本匹配条件可以直接用，扩展匹配条件需要用到扩展模块
  - ```iptables -t filter -I INPUT -s 192.168.1.1 -p tcp -m tcp --dport=22 -j DROP```  先指定协议，然后模块，然后模块中的扩展条件
  - ```iptables -t filter -I INPUT -s 192.168.1.1 -p tcp --sport=22:25 -j DROP```   当扩展条件的module名和-p一样时，可简写。端口号段
  - ```iptables -t filter -I INPUT -s 192.168.1.1 -p tcp -m multiport --dports 22,23,24:28```   multiport模块支持指定多个离散端口和段
  - ```iptables -t filter -I INPUT -m iprange --src-range 192.168.1.1-192.168.1.124 -j DROP```  iprange模块支持ip地址范围，--src-range, --dst-range
  - ```iptables -t filter -I INPUT -m string --algo bm --string "XX" -j DROP```  string模块，bm算法，匹配string
  - ```iptables -t filter -I INPUT -p tcp --dport 80 -m time --timestart 09:00:00 --timestop 18:00:00 --weekday 6,7 -j REJECT``` time模块,支持指定timestart,timestop,datestart,datestop,weekday,monthday
  - ```iptables -t filter -I INPUT -p tcp --dport 22 -m connlimit --connlimit-above 2 -j DROP```  connlimit模块限制每个ip的连接上限
  - ```iptables -t filter -I INPUT -p icmp -m limit --limit-burst 3 --limit 10/minute -j ACCEPT```   桶中最多3个令牌，每分钟生成10个令牌。limit令牌用了令牌桶算法
  - ```iptables -t filter -I INPUT -p tcp -m tcp --dport 22 --tcp-flags SYN,ACK,FIN,RST,URG,PSH SYN -j REJECT``` 匹配tcp头部flag，先指定标志位列表，再指定谁为1
  - ```iptables -t filter -I INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT```
  -  ```iptables -t filter -A INPUT -j REJECT```
      - 上面的例子，本机可以访问别人，但是别人无法访问自己
      - state模块让iptables实现连接追踪. 状态有: NEW、ESTABLISHED、RELATED、INVALID、UNTRACKED
      - 如果想要追踪ftp，需加载内核模块`nf_conntrack_ftp`
- 当默认策略是ACCEPT时，rule都是DROP或REJECT，因为再设成ACCEPT就没有意义了
  - ```iptables -P INPUT DROP```   默认让INPUT的策略是DROP，但很不好，如果iptables -F了，自己都进不去了，最好还是默认ACCEPT，最后加一条REJECT
- 自定义chain
  - ```iptables -t filter -N MY_IN``` 创建新chain
  - ```iptables -t filter -I MY_IN -s 192.168.1.1 -j DROP```
  - ```iptables -t filter -I INPUT -p tcp --dport 80 -j MY_IN```  MY_IN是个target
  - ```iptables -E MY_IN MY_IN_2```  rename
  - ```iptales -X MY_IN_2``` 删除chain。 需要清空自定义链，才可以删除。 ```iptables -t filter -F MY_IN_2```
- 当把iptables当做边界防火墙时，只能用FORWARD chain
- action
  - 每个action都有自己的选项，例如`-j REJECT --reject-with icmp-host-unreachable`
  - -j LOG ，记录日志到/var/log/messages里
- NAT
  - ```iptables -t nat -A POSTROUTING -s 10.0.0.1/16 -j SNAT --to-source 192.168.1.1```    不用特意设置DNAT，iptables会自动维护NAT表，匹配回包
  - ```iptables -t nat -I PREROUTING -d 192.168.1.1 -p tcp --dport 339 -j DNAT --to-destination 10.1.0.1:339```
  - MASQUERADE和SNAT类似，不同点在于SNAT明确指定ip，而MASQUERADE会动态指定成网卡上的可用ip
    - ```iptables -t nat -A POSTROUTING -s 10.0.0.1/16 -o eth1 -j MASQUERADE```
  - REDIRECT在本机进行端口映射
    - ```iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080``` 
